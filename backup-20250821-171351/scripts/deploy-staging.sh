#!/bin/bash

# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ Ğ² staging ÑÑ€ĞµĞ´Ñƒ
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: ./scripts/deploy-staging.sh

set -e

echo "ğŸš€ Starting staging deployment..."

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¼Ñ‹ Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
if [ ! -f "docker-compose.staging.yml" ]; then
    echo "âŒ Error: docker-compose.staging.yml not found"
    echo "Please run this script from the project root directory"
    exit 1
fi

# ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
echo "ğŸ›‘ Stopping current containers..."
docker-compose -f docker-compose.staging.yml down || true

# ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
echo "ğŸ“¥ Pulling latest changes..."
git fetch origin
git reset --hard origin/staging

# ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
echo "ğŸ”§ Setting up environment variables..."
cp env.staging .env.staging || true

# Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
echo "ğŸ”¨ Building and starting containers..."
docker-compose -f docker-compose.staging.yml build --no-cache
docker-compose -f docker-compose.staging.yml up -d

# Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
echo "â³ Waiting for services to start..."
sleep 30

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
echo "ğŸ” Checking deployment status..."
docker-compose -f docker-compose.staging.yml ps

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ
echo "ğŸŒ Testing application availability..."
if curl -f https://staging.Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ».Ñ€Ñ„/health > /dev/null 2>&1; then
    echo "âœ… Health check passed"
else
    echo "âš ï¸ Health check failed, but continuing..."
fi

echo "âœ… Staging deployment completed!"
echo "ğŸŒ Application available at: https://staging.Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ».Ñ€Ñ„"
echo "ğŸ“Š Container status:"
docker-compose -f docker-compose.staging.yml ps 